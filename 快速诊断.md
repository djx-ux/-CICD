# 🔍 部署失败快速诊断

## 现象
- ❌ 部署失败
- ⏱️ 只用了 19 秒就失败
- 🔴 状态：失败

## 最可能的原因

### ⚠️ GitHub Secret 未配置（90%可能）

**问题**：缺少 `SERVER_SSH_KEY`

**诊断步骤**：

### 第1步：检查 GitHub Secret

**立即访问**：
```
https://github.com/djx-ux/-CICD/settings/secrets/actions
```

**检查清单**：
- [ ] 有 `SERVER_SSH_KEY` 这个 Secret
- [ ] Secret 包含完整的 SSH 私钥
- [ ] 私钥包含 `-----BEGIN OPENSSH PRIVATE KEY-----`
- [ ] 私钥包含 `-----END OPENSSH PRIVATE KEY-----`

---

### 第2步：如果没有 SERVER_SSH_KEY

**立即添加**：

1. 访问：https://github.com/djx-ux/-CICD/settings/secrets/actions
2. 点击 **"New repository secret"**
3. 填写：

**Name（名称）**:
```
SERVER_SSH_KEY
```

**Secret（内容）**:  
复制粘贴以下**完整内容**（包括 BEGIN 和 END）：

```
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
QyNTUxOQAAACD84jYWEqraE9+rb6uToRbGMHnxN9fgbXhdSLX79bpPHwAAAKAycg75MnIO
+QAAAAtzc2gtZWQyNTUxOQAAACD84jYWEqraE9+rb6uToRbGMHnxN9fgbXhdSLX79bpPHw
AAAEA6S7x5izDScoc1KdDCf/1jNa9lLCf0dEdoxMF74g33bPziNhYSqtoT36tvq5OhFsYw
efE31+BteF1Itfv1uk8fAAAAFnlvdXJfZW1haWxAZXhhbXBsZS5jb20BAgMEBQYH
-----END OPENSSH PRIVATE KEY-----
```

4. 点击 **"Add secret"**

---

### 第3步：查看详细错误日志

**访问 GitHub Actions**：
```
https://github.com/djx-ux/-CICD/actions
```

**查看失败的工作流**：
1. 点击最新的失败的运行
2. 点击 "部署到服务器" job
3. 展开 "🔑 配置 SSH 密钥" 步骤
4. 查看错误信息

**常见错误信息**：

#### 错误 1：SECRET 为空
```
Error: Input required and not supplied: secrets.SERVER_SSH_KEY
```
**解决**：按照上面第2步添加 Secret

#### 错误 2：SSH 连接失败
```
Permission denied (publickey)
```
**解决**：确保 SSH 私钥正确，本地测试：
```bash
ssh root@119.29.95.149
```

#### 错误 3：服务器无法访问
```
Connection timed out
```
**解决**：检查服务器是否在线

---

## 🔧 立即修复步骤

### 方案 A：添加 GitHub Secret（最可能）

```bash
# 第1步：访问
https://github.com/djx-ux/-CICD/settings/secrets/actions

# 第2步：添加 SERVER_SSH_KEY（使用上面提供的完整私钥）

# 第3步：重新运行工作流
# 在 GitHub Actions 页面点击 "Re-run all jobs"
```

### 方案 B：本地测试 SSH

```bash
# 测试 SSH 连接
ssh root@119.29.95.149

# 如果连接成功，说明私钥正确
# 如果失败，说明私钥或服务器有问题
```

### 方案 C：手动部署（临时）

```bash
# 如果 GitHub Actions 一直失败，可以先手动部署
./fix-server.sh
```

---

## 📊 完整诊断流程

```
1. 检查 GitHub Secret
   ├─ 有 SERVER_SSH_KEY → 继续
   └─ 没有 → 立即添加（见第2步）

2. 查看 Actions 日志
   ├─ 错误：Secret 为空 → 添加 Secret
   ├─ 错误：SSH 失败 → 检查私钥格式
   └─ 错误：连接超时 → 检查服务器

3. 本地测试 SSH
   ├─ 成功 → GitHub Secret 配置有问题
   └─ 失败 → 服务器或网络问题

4. 重新运行部署
   → 在 Actions 页面点击 "Re-run all jobs"
```

---

## ✅ 验证修复

### 修复后，重新运行：

1. **添加 Secret 后**：
   ```
   访问：https://github.com/djx-ux/-CICD/actions
   点击最新的失败运行
   点击 "Re-run all jobs"
   ```

2. **观察运行**：
   ```
   🚀 一键部署到服务器
    ├─ 📥 检出代码            ✅
    ├─ 🔑 配置 SSH 密钥       ✅ (应该成功)
    ├─ 🔌 测试 SSH 连接       ✅ (应该成功)
    ├─ 📁 创建部署目录        ✅
    ├─ 🔄 同步代码到服务器    ✅
    ├─ 🐳 部署 Docker 容器    ✅
    ├─ ✅ 验证部署            ✅
    └─ 📍 显示访问信息        ✅
   ```

3. **预期时间**：3-5 分钟

---

## 🎯 最可能的解决方案

### 99% 可能性：缺少 SERVER_SSH_KEY

**立即执行**：

```bash
# 1. 打开浏览器
https://github.com/djx-ux/-CICD/settings/secrets/actions

# 2. 点击 "New repository secret"

# 3. 添加：
Name: SERVER_SSH_KEY
Secret: [粘贴上面提供的完整私钥]

# 4. 保存后，重新运行 Actions
```

---

## 📞 需要更多帮助？

### 查看详细错误

```bash
# 访问 Actions 日志
https://github.com/djx-ux/-CICD/actions

# 点击失败的运行
# 展开每个步骤查看详细错误
```

### 本地测试

```bash
# 测试 SSH
ssh root@119.29.95.149

# 查看服务器状态
ssh root@119.29.95.149 "docker ps"
```

---

## 🚀 快速修复命令

```bash
# 如果 GitHub Secret 已配置但还是失败
# 在 Actions 页面点击：
# Re-run all jobs

# 或者推送一个新提交触发
git commit --allow-empty -m "trigger: 重新触发部署"
git push origin main
```

---

**诊断时间**: 1 分钟  
**修复时间**: 2 分钟  
**重新部署**: 5 分钟  
**总计**: 约 8 分钟

**现在就开始第1步：检查 GitHub Secret！** 🔍

