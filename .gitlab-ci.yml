# GitLab CI/CD é…ç½®æ–‡ä»¶
# é€‚ç”¨äºä½¿ç”¨ GitLab çš„å›¢é˜Ÿ

stages:
  - lint      # ä»£ç æ£€æŸ¥
  - test      # æµ‹è¯•
  - build     # æ„å»º
  - deploy    # éƒ¨ç½²

variables:
  DOCKER_REGISTRY: registry.cn-hangzhou.aliyuncs.com
  IMAGE_NAME: gva
  GO_VERSION: "1.22"
  NODE_VERSION: "20"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

# ============================================
# å‰ç«¯ä»£ç æ£€æŸ¥
# ============================================
frontend-lint:
  stage: lint
  image: node:20
  cache:
    key: ${CI_COMMIT_REF_SLUG}-pnpm
    paths:
      - web/node_modules/
  script:
    - cd web
    - corepack enable
    - corepack prepare pnpm@10.18.3 --activate
    - pnpm install --frozen-lockfile
    - pnpm lint || true
  only:
    - branches
    - merge_requests

# ============================================
# åç«¯ä»£ç æ£€æŸ¥
# ============================================
backend-lint:
  stage: lint
  image: golang:1.22
  cache:
    key: ${CI_COMMIT_REF_SLUG}-go
    paths:
      - server/.go/
  script:
    - cd server
    - go env -w GOPROXY=https://goproxy.cn,direct
    - go mod download
    - go vet ./...
    - gofmt -l . | tee /dev/stderr | [ -z "$(cat)" ]
  only:
    - branches
    - merge_requests

# ============================================
# åç«¯å•å…ƒæµ‹è¯•
# ============================================
backend-test:
  stage: test
  image: golang:1.22
  services:
    - name: mysql:8.0
      alias: mysql
      command: ["--character-set-server=utf8mb4", "--collation-server=utf8mb4_unicode_ci"]
    - name: redis:6.0
      alias: redis
  variables:
    MYSQL_ROOT_PASSWORD: root
    MYSQL_DATABASE: qmPlus
    MYSQL_USER: gva
    MYSQL_PASSWORD: Aa@6447985
  cache:
    key: ${CI_COMMIT_REF_SLUG}-go
    paths:
      - server/.go/
  script:
    - cd server
    - go env -w GOPROXY=https://goproxy.cn,direct
    - go mod download
    - go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
    - go tool cover -func=coverage.out
  coverage: '/total:\s+\(statements\)\s+(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: server/coverage.out
  only:
    - branches
    - merge_requests

# ============================================
# æ„å»º Docker é•œåƒ
# ============================================
build-images:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $DOCKER_REGISTRY
  script:
    # ç”Ÿæˆé•œåƒæ ‡ç­¾
    - export TAG="${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}-$(date +%Y%m%d%H%M%S)"
    - echo "æ„å»ºæ ‡ç­¾: $TAG"
    
    # æ„å»ºåç«¯é•œåƒ
    - cd server
    - docker build -t ${DOCKER_REGISTRY}/${IMAGE_NAME}/server:${TAG} .
    - docker tag ${DOCKER_REGISTRY}/${IMAGE_NAME}/server:${TAG} ${DOCKER_REGISTRY}/${IMAGE_NAME}/server:${CI_COMMIT_REF_SLUG}-latest
    - docker push ${DOCKER_REGISTRY}/${IMAGE_NAME}/server:${TAG}
    - docker push ${DOCKER_REGISTRY}/${IMAGE_NAME}/server:${CI_COMMIT_REF_SLUG}-latest
    - cd ..
    
    # æ„å»ºå‰ç«¯é•œåƒ
    - cd web
    - docker build -t ${DOCKER_REGISTRY}/${IMAGE_NAME}/web:${TAG} .
    - docker tag ${DOCKER_REGISTRY}/${IMAGE_NAME}/web:${TAG} ${DOCKER_REGISTRY}/${IMAGE_NAME}/web:${CI_COMMIT_REF_SLUG}-latest
    - docker push ${DOCKER_REGISTRY}/${IMAGE_NAME}/web:${TAG}
    - docker push ${DOCKER_REGISTRY}/${IMAGE_NAME}/web:${CI_COMMIT_REF_SLUG}-latest
    - cd ..
    
    # ä¿å­˜æ ‡ç­¾ä¾›éƒ¨ç½²ä½¿ç”¨
    - echo "$TAG" > image_tag.txt
  artifacts:
    paths:
      - image_tag.txt
    expire_in: 1 week
  only:
    - develop
    - release/*
    - main
    - tags

# ============================================
# éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
# ============================================
deploy-dev:
  stage: deploy
  image: bitnami/kubectl:latest
  before_script:
    - mkdir -p ~/.kube
    - echo "$KUBE_CONFIG_DEV" | base64 -d > ~/.kube/config
  script:
    - export TAG=$(cat image_tag.txt)
    - echo "éƒ¨ç½²ç‰ˆæœ¬: $TAG"
    
    # æ›´æ–° Deployment
    - kubectl set image deployment/gva-server gin-vue-admin-container=${DOCKER_REGISTRY}/${IMAGE_NAME}/server:${TAG} -n gva-dev
    - kubectl set image deployment/gva-web gva-web-container=${DOCKER_REGISTRY}/${IMAGE_NAME}/web:${TAG} -n gva-dev
    
    # ç­‰å¾…éƒ¨ç½²å®Œæˆ
    - kubectl rollout status deployment/gva-server -n gva-dev --timeout=5m
    - kubectl rollout status deployment/gva-web -n gva-dev --timeout=5m
    
    - echo "âœ… å¼€å‘ç¯å¢ƒéƒ¨ç½²æˆåŠŸ"
  environment:
    name: development
    url: https://dev.yourdomain.com
  only:
    - develop

# ============================================
# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
# ============================================
deploy-prod:
  stage: deploy
  image: bitnami/kubectl:latest
  before_script:
    - mkdir -p ~/.kube
    - echo "$KUBE_CONFIG_PROD" | base64 -d > ~/.kube/config
  script:
    - export TAG=$(cat image_tag.txt)
    - echo "éƒ¨ç½²ç‰ˆæœ¬: $TAG"
    
    # é‡‘ä¸é›€å‘å¸ƒï¼ˆå…ˆéƒ¨ç½²ä¸€å°éƒ¨åˆ†ï¼‰
    - echo "ğŸ¤ é‡‘ä¸é›€å‘å¸ƒ - 10% æµé‡"
    - kubectl set image deployment/gva-server gin-vue-admin-container=${DOCKER_REGISTRY}/${IMAGE_NAME}/server:${TAG} -n gva-prod
    - sleep 60
    
    # å…¨é‡å‘å¸ƒ
    - echo "ğŸš€ å…¨é‡å‘å¸ƒ"
    - kubectl set image deployment/gva-web gva-web-container=${DOCKER_REGISTRY}/${IMAGE_NAME}/web:${TAG} -n gva-prod
    
    # ç­‰å¾…éƒ¨ç½²å®Œæˆ
    - kubectl rollout status deployment/gva-server -n gva-prod --timeout=10m
    - kubectl rollout status deployment/gva-web -n gva-prod --timeout=10m
    
    - echo "âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸ"
  environment:
    name: production
    url: https://www.yourdomain.com
  when: manual  # éœ€è¦æ‰‹åŠ¨è§¦å‘
  only:
    - main
    - tags

# ============================================
# éƒ¨ç½²åè‡ªåŠ¨åŒ–æµ‹è¯•
# ============================================
e2e-test:
  stage: deploy
  image: node:20
  script:
    - cd web
    - corepack enable
    - pnpm install
    - pnpm test:e2e || true
  only:
    - develop
  needs: ["deploy-dev"]



