# 🚀 立即部署 - 完整步骤

## ✅ 你的配置信息

- **GitHub 仓库**: `https://github.com/djx-ux/-CICD`
- **服务器 IP**: `119.29.95.149`
- **SSH 用户**: `root`
- **部署目录**: `/opt/gin-vue-admin`

---

## 📝 第1步：配置 GitHub Secret（必需，2分钟）

### 1. 打开 GitHub Secrets 页面

直接访问这个链接：

```
https://github.com/djx-ux/-CICD/settings/secrets/actions
```

### 2. 添加 SSH 密钥

点击右上角的 **"New repository secret"** 按钮

填写以下信息：

**Name（名称）**:
```
SERVER_SSH_KEY
```

**Secret（密钥内容）**:  
复制粘贴以下完整内容（包括开头和结尾的横线）：

```
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
QyNTUxOQAAACD84jYWEqraE9+rb6uToRbGMHnxN9fgbXhdSLX79bpPHwAAAKAycg75MnIO
+QAAAAtzc2gtZWQyNTUxOQAAACD84jYWEqraE9+rb6uToRbGMHnxN9fgbXhdSLX79bpPHw
AAAEA6S7x5izDScoc1KdDCf/1jNa9lLCf0dEdoxMF74g33bPziNhYSqtoT36tvq5OhFsYw
efE31+BteF1Itfv1uk8fAAAAFnlvdXJfZW1haWxAZXhhbXBsZS5jb20BAgMEBQYH
-----END OPENSSH PRIVATE KEY-----
```

点击 **"Add secret"** 保存。

✅ **完成后你会看到**: Secret 列表中出现 `SERVER_SSH_KEY`

---

## 📝 第2步：准备服务器（1分钟）

在终端运行：

```bash
# SSH 连接到你的服务器
ssh root@119.29.95.149
```

然后在服务器上运行：

```bash
# 创建部署目录
mkdir -p /opt/gin-vue-admin

# 验证 Docker 已安装
docker --version && docker-compose --version

# 如果显示版本号，说明 Docker 已安装 ✅
# 如果提示命令不存在，运行以下命令安装：
# curl -fsSL https://get.docker.com | sh

# 完成后输入 exit 退出服务器
exit
```

---

## 📝 第3步：推送代码触发部署（1分钟）

回到你的本地项目目录，在终端运行：

```bash
# 确保在项目目录
cd /Users/ykmz/Desktop/哈雷彗星/gin-vue-admin

# 查看当前分支
git branch

# 添加所有文件
git add .

# 提交更改
git commit -m "feat: 配置自动化CI/CD部署到服务器"

# 推送到 GitHub（触发自动部署）
git push origin main
```

如果你使用的是 develop 分支，改成：
```bash
git push origin develop
```

---

## 📊 第4步：观察部署过程（3-5分钟）

### 方式 A：在 GitHub 查看

1. 访问 Actions 页面：
   ```
   https://github.com/djx-ux/-CICD/actions
   ```

2. 你会看到工作流 **"部署到腾讯云服务器"** 正在运行

3. 点击进入查看实时日志：
   - ✅ 代码检查和测试
   - ✅ SSH 连接服务器
   - ✅ 同步代码文件
   - ✅ 构建 Docker 镜像
   - ✅ 部署新容器
   - ✅ 验证部署

### 方式 B：在服务器查看

新开一个终端窗口：

```bash
# SSH 到服务器
ssh root@119.29.95.149

# 实时查看容器状态（每秒刷新）
watch -n 1 docker ps

# 或者查看部署日志
tail -f /opt/gin-vue-admin/deploy.log
```

---

## 🌐 第5步：访问你的应用

部署完成后（GitHub Actions 显示绿色✓），在浏览器访问：

- **前端**: http://119.29.95.149:8080
- **后端**: http://119.29.95.149:8888

---

## ✅ 验证部署成功

### 在服务器验证

```bash
# SSH 到服务器
ssh root@119.29.95.149

# 1. 查看容器状态（应该都是 Up）
docker ps

# 输出示例：
# CONTAINER ID   IMAGE                    STATUS          PORTS
# xxxxx          docker-compose-web       Up 2 minutes    0.0.0.0:80->80/tcp
# xxxxx          docker-compose-serv      Up 2 minutes    0.0.0.0:8888->8888/tcp

# 2. 查看容器日志（检查是否有错误）
docker logs docker-compose-web --tail 20
docker logs docker-compose-serv --tail 20

# 3. 测试本地访问
curl -I http://localhost:8080
curl -I http://localhost:8888
```

### 在浏览器验证

1. 访问 http://119.29.95.149:8080 - 应该看到前端页面
2. 访问 http://119.29.95.149:8888 - 应该看到后端响应

如果都能访问，**恭喜你部署成功！** 🎉

---

## 🔥 可能遇到的问题

### 问题 1：GitHub Actions 失败 - SSH 连接错误

**错误信息**: `Permission denied (publickey)`

**原因**: SSH 密钥配置不正确

**解决方法**:
1. 重新检查 GitHub Secret `SERVER_SSH_KEY` 的内容
2. 确保包含了 `-----BEGIN OPENSSH PRIVATE KEY-----` 和 `-----END OPENSSH PRIVATE KEY-----`
3. 确保没有多余的空格或换行

**测试 SSH 连接**:
```bash
# 在本地测试（需要先保存私钥到文件）
ssh -i ~/.ssh/test_key root@119.29.95.149
```

### 问题 2：容器无法访问

**情况 A：容器没有运行**

```bash
# 查看容器状态
docker ps -a

# 如果容器是 Exited 状态，查看日志
docker logs docker-compose-web
docker logs docker-compose-serv

# 手动启动
cd /opt/gin-vue-admin/deploy/docker-compose
docker-compose up -d
```

**情况 B：端口无法访问**

```bash
# 检查端口占用
netstat -tlnp | grep :8080
netstat -tlnp | grep :8888

# 检查防火墙
ufw status

# 如果端口被阻止，开放端口
ufw allow 8080
ufw allow 8888
```

**情况 C：腾讯云安全组未开放端口**

1. 登录腾讯云控制台
2. 进入 **云服务器** → 找到你的服务器
3. 点击 **安全组** 标签
4. 确保入站规则包含：
   - TCP 8080 端口（0.0.0.0/0）
   - TCP 8888 端口（0.0.0.0/0）
   - TCP 22 端口（SSH，可限制为你的IP）

### 问题 3：docker-compose 文件找不到

**错误**: `docker-compose.yaml not found`

**解决**:
```bash
# SSH 到服务器
ssh root@119.29.95.149

# 查看文件是否存在
ls -la /opt/gin-vue-admin/
ls -la /opt/gin-vue-admin/deploy/docker-compose/

# 如果文件不存在，可能是代码同步失败
# 检查 GitHub Actions 日志中的 "同步代码到服务器" 步骤
```

---

## 🔄 后续使用

### 每次更新代码

```bash
# 1. 修改代码
# ... 编写你的功能 ...

# 2. 提交到 Git
git add .
git commit -m "feat: 描述你的更新"

# 3. 推送到 GitHub
git push origin main

# 4. 等待自动部署（3-5分钟）
# 访问 https://github.com/djx-ux/-CICD/actions 查看进度

# 5. 部署完成后，刷新浏览器查看更新
```

就这么简单！每次推送都会自动部署 🚀

### 手动管理服务器

```bash
# 连接服务器
ssh root@119.29.95.149

# 查看容器
docker ps

# 查看日志
docker logs -f docker-compose-web
docker logs -f docker-compose-serv

# 重启容器
docker restart docker-compose-web
docker restart docker-compose-serv

# 或使用 docker-compose
cd /opt/gin-vue-admin/deploy/docker-compose
docker-compose restart
```

---

## 📋 快速命令参考

### 服务器操作

```bash
# 连接
ssh root@119.29.95.149

# 查看容器
docker ps
docker ps -a  # 包括已停止的

# 查看日志
docker logs -f [容器名]
docker logs --tail 100 [容器名]

# 重启服务
docker restart [容器名]
cd /opt/gin-vue-admin/deploy/docker-compose && docker-compose restart

# 查看资源
docker stats
htop
df -h
```

### Git 操作

```bash
# 查看状态
git status
git log --oneline -5

# 推送代码
git push origin main

# 回滚（如果需要）
git revert HEAD
git push origin main
```

---

## 🎉 完成！

现在你拥有了：

✅ **全自动部署** - 推送代码 → 自动部署到服务器  
✅ **实时反馈** - GitHub Actions 显示部署进度  
✅ **便捷管理** - SSH 随时查看服务状态  
✅ **快速回滚** - Git revert 即可回滚版本  

---

## 📞 需要帮助？

- **GitHub Actions 日志**: https://github.com/djx-ux/-CICD/actions
- **详细文档**: 查看 `SERVER_DEPLOY_GUIDE.md`
- **服务器日志**: `ssh root@119.29.95.149` 然后 `docker logs`

---

**现在就开始第1步吧！** 👉 [配置 GitHub Secret](#-第1步配置-github-secret必需2分钟)

配置完成后推送代码，等待3-5分钟，你的应用就会自动部署到服务器！🚀

