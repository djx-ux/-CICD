name: éƒ¨ç½²åˆ°è…¾è®¯äº‘æœåŠ¡å™¨

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  SERVER_HOST: 119.29.95.149
  SERVER_USER: root
  DEPLOY_PATH: /opt/gin-vue-admin
  DOCKER_COMPOSE_FILE: docker-compose.yaml

jobs:
  # ============================================
  # ä»£ç æ£€æŸ¥å’Œæµ‹è¯•
  # ============================================
  test:
    name: ä»£ç æ£€æŸ¥å’Œæµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: è®¾ç½® Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      
      - name: å‰ç«¯ä»£ç æ£€æŸ¥
        run: |
          cd web
          npm install
          npm run lint || true
          echo "âœ… å‰ç«¯æ£€æŸ¥å®Œæˆ"
      
      - name: åç«¯ä»£ç æ£€æŸ¥
        run: |
          cd server
          go mod download
          go build -v -o server .
          echo "âœ… åç«¯æ£€æŸ¥å®Œæˆ"

  # ============================================
  # éƒ¨ç½²åˆ°æœåŠ¡å™¨
  # ============================================
  deploy:
    name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: é…ç½® SSH å¯†é’¥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: æµ‹è¯• SSH è¿æ¥
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "echo 'âœ… SSH è¿æ¥æˆåŠŸ'"
      
      - name: åˆ›å»ºéƒ¨ç½²ç›®å½•
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "mkdir -p ${{ env.DEPLOY_PATH }}"
      
      - name: åŒæ­¥ä»£ç åˆ°æœåŠ¡å™¨
        run: |
          # å®‰è£… rsyncï¼ˆå¦‚æœéœ€è¦ï¼‰
          sudo apt-get update
          sudo apt-get install -y rsync
          
          # æ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='web/dist' \
            --exclude='web/node_modules' \
            --exclude='server/go.sum' \
            --exclude='.github' \
            ./ ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/
          
          echo "âœ… ä»£ç åŒæ­¥å®Œæˆ"
      
      - name: æ„å»ºå¹¶éƒ¨ç½²æœåŠ¡
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            set -e
            cd ${{ env.DEPLOY_PATH }}
            
            echo "ğŸ“¦ å½“å‰ç›®å½•: $(pwd)"
            echo "ğŸ“‹ æ–‡ä»¶åˆ—è¡¨:"
            ls -la
            
            # æ£€æŸ¥ docker-compose æ–‡ä»¶
            if [ -f "deploy/docker-compose/docker-compose.yaml" ]; then
              COMPOSE_FILE="deploy/docker-compose/docker-compose.yaml"
            elif [ -f "docker-compose.yaml" ]; then
              COMPOSE_FILE="docker-compose.yaml"
            elif [ -f "docker-compose.yml" ]; then
              COMPOSE_FILE="docker-compose.yml"
            else
              echo "âŒ æ‰¾ä¸åˆ° docker-compose æ–‡ä»¶"
              exit 1
            fi
            
            echo "ğŸ”§ ä½¿ç”¨é…ç½®æ–‡ä»¶: $COMPOSE_FILE"
            
            # åœæ­¢æ—§å®¹å™¨
            echo "â¹ï¸  åœæ­¢æ—§å®¹å™¨..."
            docker-compose -f $COMPOSE_FILE down || true
            
            # æ„å»ºæ–°é•œåƒ
            echo "ğŸ”¨ æ„å»ºæ–°é•œåƒ..."
            docker-compose -f $COMPOSE_FILE build --no-cache
            
            # å¯åŠ¨æ–°å®¹å™¨
            echo "ğŸš€ å¯åŠ¨æ–°å®¹å™¨..."
            docker-compose -f $COMPOSE_FILE up -d
            
            # æ¸…ç†æ—§é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
            docker image prune -f
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          ENDSSH
      
      - name: éªŒè¯éƒ¨ç½²
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            echo "ğŸ” æ£€æŸ¥å®¹å™¨çŠ¶æ€..."
            docker ps -a
            
            echo ""
            echo "ğŸ“Š å®¹å™¨èµ„æºä½¿ç”¨:"
            docker stats --no-stream
            
            echo ""
            echo "âœ… éƒ¨ç½²éªŒè¯å®Œæˆ"
          ENDSSH
      
      - name: æ˜¾ç¤ºè®¿é—®åœ°å€
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo ""
          echo "ğŸ“ è®¿é—®åœ°å€:"
          echo "  å‰ç«¯: http://${{ env.SERVER_HOST }}:8080"
          echo "  åç«¯: http://${{ env.SERVER_HOST }}:8888"
          echo ""
          echo "ğŸ”§ æœåŠ¡å™¨ç®¡ç†:"
          echo "  SSH: ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}"
          echo "  æŸ¥çœ‹æ—¥å¿—: docker-compose -f ${{ env.DEPLOY_PATH }}/deploy/docker-compose/docker-compose.yaml logs -f"
      
      - name: å‘é€éƒ¨ç½²é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            STATUS="âœ… éƒ¨ç½²æˆåŠŸ"
            COLOR="info"
          else
            STATUS="âŒ éƒ¨ç½²å¤±è´¥"
            COLOR="warning"
          fi
          
          echo "$STATUS"
          echo "åˆ†æ”¯: ${{ github.ref_name }}"
          echo "æäº¤è€…: ${{ github.actor }}"
          echo "è®¿é—®: http://${{ env.SERVER_HOST }}"

