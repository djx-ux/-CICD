name: CD - è…¾è®¯äº‘ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'éƒ¨ç½²ç‰ˆæœ¬ï¼ˆé•œåƒæ ‡ç­¾ï¼‰'
        required: true
        default: 'latest'

env:
  K8S_NAMESPACE: gva-prod

jobs:
  # ============================================
  # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼ˆéœ€å®¡æ‰¹ï¼‰
  # ============================================
  deploy-production:
    name: éƒ¨ç½²åˆ°è…¾è®¯äº‘ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://www.yourdomain.com
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ç”Ÿæˆéƒ¨ç½²ç‰ˆæœ¬
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.version }}"
          elif [[ ${GITHUB_REF} == refs/tags/* ]]; then
            TAG=${GITHUB_REF#refs/tags/}
          else
            COMMIT_SHA=${GITHUB_SHA::8}
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            TAG="main-${COMMIT_SHA}-${TIMESTAMP}"
          fi
          echo "TAG=${TAG}" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ éƒ¨ç½²ç‰ˆæœ¬: ${TAG}"
      
      - name: é…ç½® kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
      
      - name: éªŒè¯é›†ç¾¤è¿æ¥
        run: |
          kubectl cluster-info
          kubectl get nodes
      
      - name: åˆ›å»ºéƒ¨ç½²å¤‡ä»½
        run: |
          echo "ğŸ’¾ åˆ›å»ºéƒ¨ç½²å¤‡ä»½..."
          
          # å¤‡ä»½å½“å‰éƒ¨ç½²é…ç½®
          kubectl get deployment gva-server -n ${{ env.K8S_NAMESPACE }} -o yaml > backup-server-deployment.yaml 2>/dev/null || echo "åç«¯æœåŠ¡ä¸å­˜åœ¨"
          kubectl get deployment gva-web -n ${{ env.K8S_NAMESPACE }} -o yaml > backup-web-deployment.yaml 2>/dev/null || echo "å‰ç«¯æœåŠ¡ä¸å­˜åœ¨"
          
          echo "âœ… éƒ¨ç½²é…ç½®å·²å¤‡ä»½"
      
      - name: ä¸Šä¼ å¤‡ä»½é…ç½®
        uses: actions/upload-artifact@v4
        with:
          name: deployment-backup-${{ steps.version.outputs.TAG }}
          path: |
            backup-*.yaml
          retention-days: 90
      
      - name: ç¡®ä¿å‘½åç©ºé—´å’Œå¯†é’¥å­˜åœ¨
        run: |
          # åˆ›å»ºå‘½åç©ºé—´
          kubectl create namespace ${{ env.K8S_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
          
          # åˆ›å»ºé•œåƒæ‹‰å–å¯†é’¥
          if ! kubectl get secret tcr-secret -n ${{ env.K8S_NAMESPACE }} &> /dev/null; then
            echo "åˆ›å»ºé•œåƒæ‹‰å–å¯†é’¥..."
            kubectl create secret docker-registry tcr-secret \
              --docker-server=${{ secrets.DOCKER_REGISTRY }} \
              --docker-username=${{ secrets.DOCKER_USERNAME }} \
              --docker-password=${{ secrets.DOCKER_PASSWORD }} \
              --namespace=${{ env.K8S_NAMESPACE }}
          fi
      
      - name: é‡‘ä¸é›€å‘å¸ƒ - éƒ¨ç½²æ–°ç‰ˆæœ¬
        run: |
          echo "ğŸ¤ å¼€å§‹é‡‘ä¸é›€å‘å¸ƒ..."
          
          SERVER_IMAGE="${{ secrets.DOCKER_REGISTRY }}/gva/server:${{ steps.version.outputs.TAG }}"
          
          # æ›´æ–°åç«¯é•œåƒï¼ˆé‡‘ä¸é›€é˜¶æ®µï¼‰
          kubectl set image deployment/gva-server \
            gin-vue-admin-container="${SERVER_IMAGE}" \
            -n ${{ env.K8S_NAMESPACE }}
          
          # ç­‰å¾…éƒ¨åˆ† Pod æ›´æ–°
          echo "â±ï¸ ç­‰å¾…é‡‘ä¸é›€ç‰ˆæœ¬å¯åŠ¨..."
          sleep 60
      
      - name: é‡‘ä¸é›€å¥åº·æ£€æŸ¥
        run: |
          echo "ğŸ¥ æ‰§è¡Œé‡‘ä¸é›€å¥åº·æ£€æŸ¥..."
          
          # æ£€æŸ¥æ–° Pod çŠ¶æ€
          kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=gva-server
          
          # æ£€æŸ¥è¿è¡Œä¸­çš„ Pod æ•°é‡
          RUNNING_PODS=$(kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=gva-server --field-selector=status.phase=Running -o json | jq '.items | length')
          
          if [ "$RUNNING_PODS" -eq 0 ]; then
            echo "âŒ é‡‘ä¸é›€ç‰ˆæœ¬éƒ¨ç½²å¤±è´¥ï¼Œæ²¡æœ‰æ­£åœ¨è¿è¡Œçš„ Pod"
            exit 1
          fi
          
          echo "âœ… é‡‘ä¸é›€ç‰ˆæœ¬è¿è¡Œæ­£å¸¸ (${RUNNING_PODS} ä¸ª Pod)"
          
          # æ£€æŸ¥æœ€æ–° Pod çš„æ—¥å¿—æ˜¯å¦æœ‰ä¸¥é‡é”™è¯¯
          LATEST_POD=$(kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=gva-server --sort-by=.metadata.creationTimestamp -o jsonpath='{.items[-1].metadata.name}')
          echo "ğŸ“‹ æ£€æŸ¥æœ€æ–° Pod æ—¥å¿—: ${LATEST_POD}"
          
          ERROR_COUNT=$(kubectl logs ${LATEST_POD} -n ${{ env.K8S_NAMESPACE }} --tail=100 | grep -i "error\|fatal\|panic" | wc -l || echo 0)
          
          if [ "$ERROR_COUNT" -gt 10 ]; then
            echo "âŒ æ£€æµ‹åˆ°å¤§é‡é”™è¯¯æ—¥å¿— (${ERROR_COUNT} æ¡)"
            kubectl logs ${LATEST_POD} -n ${{ env.K8S_NAMESPACE }} --tail=50
            exit 1
          fi
          
          echo "âœ… é‡‘ä¸é›€å¥åº·æ£€æŸ¥é€šè¿‡"
      
      - name: å…¨é‡å‘å¸ƒ
        run: |
          echo "ğŸš€ å¼€å§‹å…¨é‡å‘å¸ƒ..."
          
          WEB_IMAGE="${{ secrets.DOCKER_REGISTRY }}/gva/web:${{ steps.version.outputs.TAG }}"
          
          # æ›´æ–°å‰ç«¯é•œåƒ
          kubectl set image deployment/gva-web \
            gva-web-container="${WEB_IMAGE}" \
            -n ${{ env.K8S_NAMESPACE }}
          
          # ç­‰å¾…æ‰€æœ‰æœåŠ¡å®Œå…¨å°±ç»ª
          echo "â³ ç­‰å¾…åç«¯æœåŠ¡å®Œå…¨å°±ç»ª..."
          kubectl rollout status deployment/gva-server -n ${{ env.K8S_NAMESPACE }} --timeout=15m
          
          echo "â³ ç­‰å¾…å‰ç«¯æœåŠ¡å®Œå…¨å°±ç»ª..."
          kubectl rollout status deployment/gva-web -n ${{ env.K8S_NAMESPACE }} --timeout=15m
          
          echo "âœ… å…¨é‡å‘å¸ƒå®Œæˆ"
      
      - name: ç”Ÿäº§ç¯å¢ƒéªŒè¯
        run: |
          echo "ğŸ” æ‰§è¡Œç”Ÿäº§ç¯å¢ƒéªŒè¯..."
          
          # ç­‰å¾…æœåŠ¡å®Œå…¨ç¨³å®š
          echo "â±ï¸ ç­‰å¾…æœåŠ¡ç¨³å®šï¼ˆ60ç§’ï¼‰..."
          sleep 60
          
          echo ""
          echo "=== Pod çŠ¶æ€ ==="
          kubectl get pods -n ${{ env.K8S_NAMESPACE }} -o wide
          
          echo ""
          echo "=== Service çŠ¶æ€ ==="
          kubectl get svc -n ${{ env.K8S_NAMESPACE }}
          
          echo ""
          echo "=== Deployment çŠ¶æ€ ==="
          kubectl get deployment -n ${{ env.K8S_NAMESPACE }}
          
          # æ£€æŸ¥æ‰€æœ‰ Pod æ˜¯å¦å¥åº·
          NOT_READY=$(kubectl get pods -n ${{ env.K8S_NAMESPACE }} --field-selector=status.phase!=Running -o json | jq '.items | length')
          
          if [ "$NOT_READY" -gt 0 ]; then
            echo "âŒ æœ‰ ${NOT_READY} ä¸ª Pod çŠ¶æ€å¼‚å¸¸"
            kubectl get pods -n ${{ env.K8S_NAMESPACE }} --field-selector=status.phase!=Running
            exit 1
          fi
          
          echo "âœ… æ‰€æœ‰ Pod çŠ¶æ€æ­£å¸¸"
          
          # å¦‚æœæœ‰å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ 
          # HEALTH_CHECK_URL="https://www.yourdomain.com/api/health"
          # HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${HEALTH_CHECK_URL})
          # if [ "$HTTP_CODE" != "200" ]; then
          #   echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥: HTTP ${HTTP_CODE}"
          #   exit 1
          # fi
          
          echo "âœ… ç”Ÿäº§ç¯å¢ƒéªŒè¯é€šè¿‡"
      
      - name: è·å–è®¿é—®åœ°å€
        id: service
        run: |
          # è·å–å¤–éƒ¨è®¿é—®åœ°å€
          EXTERNAL_IP=$(kubectl get svc gva-web -n ${{ env.K8S_NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
          EXTERNAL_HOSTNAME=$(kubectl get svc gva-web -n ${{ env.K8S_NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")
          
          if [ -n "$EXTERNAL_IP" ]; then
            ACCESS_URL="http://${EXTERNAL_IP}"
          elif [ -n "$EXTERNAL_HOSTNAME" ]; then
            ACCESS_URL="http://${EXTERNAL_HOSTNAME}"
          else
            ACCESS_URL="https://www.yourdomain.com"
          fi
          
          echo "ACCESS_URL=${ACCESS_URL}" >> $GITHUB_OUTPUT
          echo "ğŸŒ è®¿é—®åœ°å€: ${ACCESS_URL}"
      
      - name: è®°å½•éƒ¨ç½²å†å²
        run: |
          echo "ğŸ“ è®°å½•éƒ¨ç½²å†å²..."
          
          # æ·»åŠ éƒ¨ç½²æ ‡ç­¾
          kubectl annotate deployment gva-server \
            deployment.kubernetes.io/revision-date="$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            deployment.kubernetes.io/deployed-by="${GITHUB_ACTOR}" \
            deployment.kubernetes.io/version="${{ steps.version.outputs.TAG }}" \
            -n ${{ env.K8S_NAMESPACE }} --overwrite
          
          kubectl annotate deployment gva-web \
            deployment.kubernetes.io/revision-date="$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            deployment.kubernetes.io/deployed-by="${GITHUB_ACTOR}" \
            deployment.kubernetes.io/version="${{ steps.version.outputs.TAG }}" \
            -n ${{ env.K8S_NAMESPACE }} --overwrite
          
          echo "âœ… éƒ¨ç½²å†å²å·²è®°å½•"
      
      - name: å‘é€éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          DEPLOY_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          
          # ä¼ä¸šå¾®ä¿¡é€šçŸ¥
          if [ -n "${{ secrets.WECOM_WEBHOOK }}" ]; then
            curl -X POST ${{ secrets.WECOM_WEBHOOK }} \
              -H 'Content-Type: application/json' \
              -d "{
                \"msgtype\": \"markdown\",
                \"markdown\": {
                  \"content\": \"## âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸ\n\n>ç‰ˆæœ¬: **${{ steps.version.outputs.TAG }}**\n>éƒ¨ç½²æ—¶é—´: **${DEPLOY_TIME}**\n>éƒ¨ç½²äºº: **${GITHUB_ACTOR}**\n>è®¿é—®åœ°å€: **${{ steps.service.outputs.ACCESS_URL }}**\n\n[æŸ¥çœ‹è¯¦æƒ…](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID})\"
                }
              }"
          fi
          
          # é’‰é’‰é€šçŸ¥
          if [ -n "${{ secrets.DINGTALK_WEBHOOK }}" ]; then
            curl -X POST ${{ secrets.DINGTALK_WEBHOOK }} \
              -H 'Content-Type: application/json' \
              -d "{
                \"msgtype\": \"markdown\",
                \"markdown\": {
                  \"title\": \"ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸ\",
                  \"text\": \"### âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸ\n\n**ç‰ˆæœ¬**: ${{ steps.version.outputs.TAG }}\n\n**éƒ¨ç½²æ—¶é—´**: ${DEPLOY_TIME}\n\n**éƒ¨ç½²äºº**: ${GITHUB_ACTOR}\n\n**è®¿é—®åœ°å€**: ${{ steps.service.outputs.ACCESS_URL }}\n\n[æŸ¥çœ‹è¯¦æƒ…](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID})\"
                }
              }"
          fi
      
      - name: éƒ¨ç½²å¤±è´¥æ—¶å›æ»š
        if: failure()
        run: |
          echo "âŒ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å¤±è´¥ï¼Œå¼€å§‹è‡ªåŠ¨å›æ»š..."
          
          # å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
          kubectl rollout undo deployment/gva-server -n ${{ env.K8S_NAMESPACE }} || true
          kubectl rollout undo deployment/gva-web -n ${{ env.K8S_NAMESPACE }} || true
          
          # ç­‰å¾…å›æ»šå®Œæˆ
          kubectl rollout status deployment/gva-server -n ${{ env.K8S_NAMESPACE }} --timeout=10m || true
          kubectl rollout status deployment/gva-web -n ${{ env.K8S_NAMESPACE }} --timeout=10m || true
          
          echo "âœ… å·²å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬"
          
          # å‘é€å¤±è´¥é€šçŸ¥
          if [ -n "${{ secrets.WECOM_WEBHOOK }}" ]; then
            curl -X POST ${{ secrets.WECOM_WEBHOOK }} \
              -H 'Content-Type: application/json' \
              -d "{
                \"msgtype\": \"text\",
                \"text\": {
                  \"content\": \"âŒ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å¤±è´¥ï¼\nç‰ˆæœ¬: ${{ steps.version.outputs.TAG }}\nå·²è‡ªåŠ¨å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬\nè¯·ç«‹å³æ£€æŸ¥: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}\"
                },
                \"mentioned_list\": [\"@all\"]
              }"
          fi
          
          if [ -n "${{ secrets.DINGTALK_WEBHOOK }}" ]; then
            curl -X POST ${{ secrets.DINGTALK_WEBHOOK }} \
              -H 'Content-Type: application/json' \
              -d "{
                \"msgtype\": \"text\",
                \"text\": {
                  \"content\": \"âŒ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å¤±è´¥ï¼\nç‰ˆæœ¬: ${{ steps.version.outputs.TAG }}\nå·²è‡ªåŠ¨å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬\nè¯·ç«‹å³æ£€æŸ¥æ—¥å¿—\"
                },
                \"at\": {
                  \"isAtAll\": true
                }
              }"
          fi
          
          exit 1

