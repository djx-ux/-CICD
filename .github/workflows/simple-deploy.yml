name: ğŸš€ ä¸€é”®éƒ¨ç½²åˆ°æœåŠ¡å™¨

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  SERVER_HOST: 119.29.95.149
  SERVER_USER: root
  DEPLOY_PATH: /opt/gin-vue-admin

jobs:
  deploy:
    name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ”‘ é…ç½® SSH å¯†é’¥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts
          echo "âœ… SSH å¯†é’¥é…ç½®å®Œæˆ"
      
      - name: ğŸ”Œ æµ‹è¯• SSH è¿æ¥
        run: |
          echo "æµ‹è¯•è¿æ¥åˆ°: ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}"
          ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "echo 'âœ… SSH è¿æ¥æˆåŠŸï¼'"
      
      - name: ğŸ“ åˆ›å»ºéƒ¨ç½²ç›®å½•
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "mkdir -p ${{ env.DEPLOY_PATH }}"
          echo "âœ… éƒ¨ç½²ç›®å½•å·²åˆ›å»º: ${{ env.DEPLOY_PATH }}"
      
      - name: ğŸ”„ åŒæ­¥ä»£ç åˆ°æœåŠ¡å™¨
        run: |
          echo "å¼€å§‹åŒæ­¥ä»£ç ..."
          sudo apt-get update -qq
          sudo apt-get install -y -qq rsync
          
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='web/dist' \
            --exclude='web/node_modules' \
            --exclude='.github' \
            --exclude='*.md' \
            ./ ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/
          
          echo "âœ… ä»£ç åŒæ­¥å®Œæˆ"
      
      - name: ğŸ³ éƒ¨ç½² Docker å®¹å™¨
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            set -e
            
            echo "=========================================="
            echo "å¼€å§‹éƒ¨ç½²..."
            echo "=========================================="
            
            cd ${{ env.DEPLOY_PATH }}
            echo "ğŸ“‚ å½“å‰ç›®å½•: $(pwd)"
            
            # æŸ¥æ‰¾ docker-compose æ–‡ä»¶
            if [ -f "deploy/docker-compose/docker-compose.yaml" ]; then
              COMPOSE_FILE="deploy/docker-compose/docker-compose.yaml"
              COMPOSE_DIR="deploy/docker-compose"
            elif [ -f "docker-compose.yaml" ]; then
              COMPOSE_FILE="docker-compose.yaml"
              COMPOSE_DIR="."
            else
              echo "âŒ æ‰¾ä¸åˆ° docker-compose æ–‡ä»¶"
              exit 1
            fi
            
            echo "ğŸ”§ ä½¿ç”¨é…ç½®: $COMPOSE_FILE"
            cd $COMPOSE_DIR
            
            # åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
            echo ""
            echo "â¹ï¸  åœæ­¢æ—§å®¹å™¨..."
            docker-compose -f docker-compose.yaml down || true
            
            # æ¸…ç†
            echo "ğŸ§¹ æ¸…ç†èµ„æº..."
            docker container prune -f || true
            
            # æ„å»ºé•œåƒ
            echo ""
            echo "ğŸ”¨ æ„å»º Docker é•œåƒ..."
            docker-compose -f docker-compose.yaml build --no-cache
            
            # å¯åŠ¨å®¹å™¨
            echo ""
            echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
            docker-compose -f docker-compose.yaml up -d
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo ""
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼ˆ30ç§’ï¼‰..."
            sleep 30
            
            # æ˜¾ç¤ºå®¹å™¨çŠ¶æ€
            echo ""
            echo "=========================================="
            echo "ğŸ“Š å®¹å™¨çŠ¶æ€:"
            echo "=========================================="
            docker-compose -f docker-compose.yaml ps
            
            echo ""
            echo "=========================================="
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "=========================================="
          ENDSSH
      
      - name: âœ… éªŒè¯éƒ¨ç½²
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            echo ""
            echo "ğŸ” æœ€ç»ˆæ£€æŸ¥..."
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            echo ""
            echo "ğŸ“‹ è¿è¡Œä¸­çš„å®¹å™¨æ•°é‡:"
            docker ps | grep -c "Up" || echo "0"
          ENDSSH
      
      - name: ğŸ“ æ˜¾ç¤ºè®¿é—®ä¿¡æ¯
        if: success()
        run: |
          echo ""
          echo "=========================================="
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "=========================================="
          echo ""
          echo "ğŸ“ è®¿é—®åœ°å€:"
          echo "  ğŸŒ å‰ç«¯: http://${{ env.SERVER_HOST }}:8080"
          echo "  ğŸ”§ åç«¯: http://${{ env.SERVER_HOST }}:8888"
          echo ""
          echo "ğŸ”§ æœåŠ¡å™¨ç®¡ç†:"
          echo "  SSH: ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}"
          echo "  æ—¥å¿—: docker-compose -f ${{ env.DEPLOY_PATH }}/deploy/docker-compose/docker-compose.yaml logs -f"
          echo ""
      
      - name: âŒ éƒ¨ç½²å¤±è´¥å¤„ç†
        if: failure()
        run: |
          echo ""
          echo "=========================================="
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
          echo "=========================================="
          echo ""
          echo "è¯·æ£€æŸ¥:"
          echo "  1. GitHub Secret SERVER_SSH_KEY æ˜¯å¦æ­£ç¡®é…ç½®"
          echo "  2. æœåŠ¡å™¨ SSH æ˜¯å¦å¯ä»¥è¿æ¥"
          echo "  3. Docker å’Œ docker-compose æ˜¯å¦å·²å®‰è£…"
          echo ""
          echo "æŸ¥çœ‹è¯¦ç»†æ—¥å¿—:"
          echo "  ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}"
          echo "  cd ${{ env.DEPLOY_PATH }}"
          echo "  docker-compose logs"
          echo ""

