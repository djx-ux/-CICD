name: CD - è…¾è®¯äº‘å¼€å‘ç¯å¢ƒéƒ¨ç½²

on:
  workflow_run:
    workflows: ["CI - è…¾è®¯äº‘æŒç»­é›†æˆ"]
    types:
      - completed
    branches:
      - develop
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  K8S_NAMESPACE: gva-dev

jobs:
  deploy-dev:
    name: éƒ¨ç½²åˆ°è…¾è®¯äº‘å¼€å‘ç¯å¢ƒ
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    environment:
      name: development
      url: https://dev.yourdomain.com
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ç”Ÿæˆé•œåƒæ ‡ç­¾
        id: meta
        run: |
          COMMIT_SHA=${GITHUB_SHA::8}
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          TAG="develop-${COMMIT_SHA}-${TIMESTAMP}"
          echo "TAG=${TAG}" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ éƒ¨ç½²æ ‡ç­¾: ${TAG}"
      
      - name: é…ç½® kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG_DEV }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
      
      - name: éªŒè¯é›†ç¾¤è¿æ¥
        run: |
          kubectl cluster-info
          kubectl get nodes
      
      - name: åˆ›å»ºå‘½åç©ºé—´ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        run: |
          kubectl create namespace ${{ env.K8S_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
      
      - name: ç¡®ä¿é•œåƒæ‹‰å–å¯†é’¥å­˜åœ¨
        run: |
          # æ£€æŸ¥å¯†é’¥æ˜¯å¦å­˜åœ¨
          if ! kubectl get secret tcr-secret -n ${{ env.K8S_NAMESPACE }} &> /dev/null; then
            echo "åˆ›å»ºé•œåƒæ‹‰å–å¯†é’¥..."
            kubectl create secret docker-registry tcr-secret \
              --docker-server=${{ secrets.DOCKER_REGISTRY }} \
              --docker-username=${{ secrets.DOCKER_USERNAME }} \
              --docker-password=${{ secrets.DOCKER_PASSWORD }} \
              --namespace=${{ env.K8S_NAMESPACE }}
          else
            echo "âœ… é•œåƒæ‹‰å–å¯†é’¥å·²å­˜åœ¨"
          fi
      
      - name: æ›´æ–°åç«¯æœåŠ¡é•œåƒ
        run: |
          SERVER_IMAGE="${{ secrets.DOCKER_REGISTRY }}/gva/server:${{ steps.meta.outputs.TAG }}"
          echo "ğŸ“¦ æ›´æ–°åç«¯é•œåƒ: ${SERVER_IMAGE}"
          
          kubectl set image deployment/gva-server \
            gin-vue-admin-container="${SERVER_IMAGE}" \
            -n ${{ env.K8S_NAMESPACE }} || \
          kubectl create deployment gva-server \
            --image="${SERVER_IMAGE}" \
            -n ${{ env.K8S_NAMESPACE }}
      
      - name: æ›´æ–°å‰ç«¯æœåŠ¡é•œåƒ
        run: |
          WEB_IMAGE="${{ secrets.DOCKER_REGISTRY }}/gva/web:${{ steps.meta.outputs.TAG }}"
          echo "ğŸ“¦ æ›´æ–°å‰ç«¯é•œåƒ: ${WEB_IMAGE}"
          
          kubectl set image deployment/gva-web \
            gva-web-container="${WEB_IMAGE}" \
            -n ${{ env.K8S_NAMESPACE }} || \
          kubectl create deployment gva-web \
            --image="${WEB_IMAGE}" \
            -n ${{ env.K8S_NAMESPACE }}
      
      - name: ç­‰å¾…åç«¯æœåŠ¡å°±ç»ª
        run: |
          echo "â³ ç­‰å¾…åç«¯æœåŠ¡å°±ç»ª..."
          kubectl rollout status deployment/gva-server \
            -n ${{ env.K8S_NAMESPACE }} \
            --timeout=10m
          echo "âœ… åç«¯æœåŠ¡å°±ç»ª"
      
      - name: ç­‰å¾…å‰ç«¯æœåŠ¡å°±ç»ª
        run: |
          echo "â³ ç­‰å¾…å‰ç«¯æœåŠ¡å°±ç»ª..."
          kubectl rollout status deployment/gva-web \
            -n ${{ env.K8S_NAMESPACE }} \
            --timeout=10m
          echo "âœ… å‰ç«¯æœåŠ¡å°±ç»ª"
      
      - name: éªŒè¯éƒ¨ç½²
        run: |
          echo "ğŸ” éªŒè¯éƒ¨ç½²çŠ¶æ€..."
          echo ""
          echo "=== Pod çŠ¶æ€ ==="
          kubectl get pods -n ${{ env.K8S_NAMESPACE }} -o wide
          echo ""
          echo "=== Service çŠ¶æ€ ==="
          kubectl get svc -n ${{ env.K8S_NAMESPACE }}
          echo ""
          echo "=== Deployment çŠ¶æ€ ==="
          kubectl get deployment -n ${{ env.K8S_NAMESPACE }}
      
      - name: è·å–æœåŠ¡åœ°å€
        id: service
        run: |
          # è·å– LoadBalancer å¤–éƒ¨IPæˆ–åŸŸå
          EXTERNAL_IP=$(kubectl get svc gva-web -n ${{ env.K8S_NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
          EXTERNAL_HOSTNAME=$(kubectl get svc gva-web -n ${{ env.K8S_NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")
          
          if [ -n "$EXTERNAL_IP" ]; then
            ACCESS_URL="http://${EXTERNAL_IP}"
          elif [ -n "$EXTERNAL_HOSTNAME" ]; then
            ACCESS_URL="http://${EXTERNAL_HOSTNAME}"
          else
            ACCESS_URL="ä½¿ç”¨ kubectl port-forward è®¿é—®"
          fi
          
          echo "ACCESS_URL=${ACCESS_URL}" >> $GITHUB_OUTPUT
          echo "ğŸ“ è®¿é—®åœ°å€: ${ACCESS_URL}"
      
      - name: å¥åº·æ£€æŸ¥
        run: |
          echo "ğŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
          sleep 30
          
          # æ£€æŸ¥ Pod å¥åº·çŠ¶æ€
          RUNNING_PODS=$(kubectl get pods -n ${{ env.K8S_NAMESPACE }} --field-selector=status.phase=Running -o json | jq '.items | length')
          echo "âœ… è¿è¡Œä¸­çš„ Pod æ•°é‡: ${RUNNING_PODS}"
          
          if [ "$RUNNING_PODS" -eq 0 ]; then
            echo "âŒ æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„ Pod"
            exit 1
          fi
          
          echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
      
      - name: æ˜¾ç¤ºæœ€æ–°æ—¥å¿—
        if: always()
        run: |
          echo "ğŸ“‹ åç«¯æœåŠ¡æ—¥å¿—ï¼ˆæœ€è¿‘50è¡Œï¼‰:"
          kubectl logs -n ${{ env.K8S_NAMESPACE }} -l app=gva-server --tail=50 || true
          echo ""
          echo "ğŸ“‹ å‰ç«¯æœåŠ¡æ—¥å¿—ï¼ˆæœ€è¿‘50è¡Œï¼‰:"
          kubectl logs -n ${{ env.K8S_NAMESPACE }} -l app=gva-web --tail=50 || true
      
      - name: å‘é€éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          # ä¼ä¸šå¾®ä¿¡é€šçŸ¥
          if [ -n "${{ secrets.WECOM_WEBHOOK }}" ]; then
            curl -X POST ${{ secrets.WECOM_WEBHOOK }} \
              -H 'Content-Type: application/json' \
              -d "{
                \"msgtype\": \"markdown\",
                \"markdown\": {
                  \"content\": \"## ğŸš€ å¼€å‘ç¯å¢ƒéƒ¨ç½²æˆåŠŸ\n\n>ç¯å¢ƒ: **Development**\n>åˆ†æ”¯: **develop**\n>ç‰ˆæœ¬: **${{ steps.meta.outputs.TAG }}**\n>æäº¤è€…: **${GITHUB_ACTOR}**\n>è®¿é—®åœ°å€: **${{ steps.service.outputs.ACCESS_URL }}**\n\n[æŸ¥çœ‹è¯¦æƒ…](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID})\"
                }
              }"
          fi
          
          # é’‰é’‰é€šçŸ¥
          if [ -n "${{ secrets.DINGTALK_WEBHOOK }}" ]; then
            curl -X POST ${{ secrets.DINGTALK_WEBHOOK }} \
              -H 'Content-Type: application/json' \
              -d "{
                \"msgtype\": \"markdown\",
                \"markdown\": {
                  \"title\": \"å¼€å‘ç¯å¢ƒéƒ¨ç½²æˆåŠŸ\",
                  \"text\": \"### ğŸš€ å¼€å‘ç¯å¢ƒéƒ¨ç½²æˆåŠŸ\n\n**ç¯å¢ƒ**: Development\n\n**åˆ†æ”¯**: develop\n\n**ç‰ˆæœ¬**: ${{ steps.meta.outputs.TAG }}\n\n**æäº¤è€…**: ${GITHUB_ACTOR}\n\n**è®¿é—®åœ°å€**: ${{ steps.service.outputs.ACCESS_URL }}\n\n[æŸ¥çœ‹è¯¦æƒ…](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID})\"
                }
              }"
          fi
      
      - name: éƒ¨ç½²å¤±è´¥æ—¶å›æ»š
        if: failure()
        run: |
          echo "âš ï¸ éƒ¨ç½²å¤±è´¥ï¼Œå¼€å§‹å›æ»š..."
          
          kubectl rollout undo deployment/gva-server -n ${{ env.K8S_NAMESPACE }} || true
          kubectl rollout undo deployment/gva-web -n ${{ env.K8S_NAMESPACE }} || true
          
          echo "âœ… å·²å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬"
          
          # å‘é€å¤±è´¥é€šçŸ¥
          if [ -n "${{ secrets.WECOM_WEBHOOK }}" ]; then
            curl -X POST ${{ secrets.WECOM_WEBHOOK }} \
              -H 'Content-Type: application/json' \
              -d "{
                \"msgtype\": \"text\",
                \"text\": {
                  \"content\": \"âŒ å¼€å‘ç¯å¢ƒéƒ¨ç½²å¤±è´¥ï¼\nç‰ˆæœ¬: ${{ steps.meta.outputs.TAG }}\nå·²è‡ªåŠ¨å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬\næŸ¥çœ‹è¯¦æƒ…: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}\"
                }
              }"
          fi

