name: CD - å¼€å‘ç¯å¢ƒéƒ¨ç½²

on:
  push:
    branches:
      - develop
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  DOCKER_REGISTRY: registry.cn-hangzhou.aliyuncs.com
  IMAGE_NAME: gva
  K8S_NAMESPACE: gva-dev

jobs:
  deploy-dev:
    name: éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
    runs-on: ubuntu-latest
    environment:
      name: development
      url: https://dev.yourdomain.com
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ç”Ÿæˆé•œåƒæ ‡ç­¾
        id: meta
        run: |
          COMMIT_SHA=${GITHUB_SHA::8}
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          TAG="develop-${COMMIT_SHA}-${TIMESTAMP}"
          echo "TAG=${TAG}" >> $GITHUB_OUTPUT
          echo "é•œåƒæ ‡ç­¾: ${TAG}"
      
      - name: é…ç½® kubectl
        uses: azure/k8s-set-context@v4
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG_DEV }}
      
      - name: åˆ›å»ºå‘½åç©ºé—´ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        run: |
          kubectl create namespace ${{ env.K8S_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
      
      - name: æ›´æ–°åç«¯æœåŠ¡é•œåƒ
        run: |
          kubectl set image deployment/gva-server \
            gin-vue-admin-container=${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}/server:${{ steps.meta.outputs.TAG }} \
            -n ${{ env.K8S_NAMESPACE }}
      
      - name: æ›´æ–°å‰ç«¯æœåŠ¡é•œåƒ
        run: |
          kubectl set image deployment/gva-web \
            gva-web-container=${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}/web:${{ steps.meta.outputs.TAG }} \
            -n ${{ env.K8S_NAMESPACE }}
      
      - name: ç­‰å¾…åç«¯æœåŠ¡å°±ç»ª
        run: |
          kubectl rollout status deployment/gva-server \
            -n ${{ env.K8S_NAMESPACE }} \
            --timeout=5m
      
      - name: ç­‰å¾…å‰ç«¯æœåŠ¡å°±ç»ª
        run: |
          kubectl rollout status deployment/gva-web \
            -n ${{ env.K8S_NAMESPACE }} \
            --timeout=5m
      
      - name: éªŒè¯éƒ¨ç½²
        run: |
          # æ£€æŸ¥ Pod çŠ¶æ€
          kubectl get pods -n ${{ env.K8S_NAMESPACE }}
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          kubectl get svc -n ${{ env.K8S_NAMESPACE }}
          
          # è·å–æœ€æ–°çš„ Pod æ—¥å¿—
          POD_NAME=$(kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=gva-server -o jsonpath='{.items[0].metadata.name}')
          kubectl logs $POD_NAME -n ${{ env.K8S_NAMESPACE }} --tail=50
      
      - name: å¥åº·æ£€æŸ¥
        run: |
          # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
          sleep 30
          
          # å¥åº·æ£€æŸ¥ï¼ˆå¦‚æœæœ‰å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼‰
          # curl -f https://dev.yourdomain.com/api/health || exit 1
          
          echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
      
      - name: å‘é€éƒ¨ç½²é€šçŸ¥
        if: always()
        run: |
          STATUS="${{ job.status }}"
          COLOR="green"
          if [ "$STATUS" != "success" ]; then
            COLOR="red"
          fi
          
          # é’‰é’‰é€šçŸ¥
          if [ -n "${{ secrets.DINGTALK_WEBHOOK }}" ]; then
            curl -X POST ${{ secrets.DINGTALK_WEBHOOK }} \
              -H 'Content-Type: application/json' \
              -d "{
                \"msgtype\": \"markdown\",
                \"markdown\": {
                  \"title\": \"å¼€å‘ç¯å¢ƒéƒ¨ç½²é€šçŸ¥\",
                  \"text\": \"### ğŸš€ å¼€å‘ç¯å¢ƒéƒ¨ç½²é€šçŸ¥\n\n**ç¯å¢ƒ**: Development\n\n**çŠ¶æ€**: <font color='${COLOR}'>${STATUS}</font>\n\n**åˆ†æ”¯**: develop\n\n**ç‰ˆæœ¬**: ${{ steps.meta.outputs.TAG }}\n\n**æäº¤è€…**: ${GITHUB_ACTOR}\n\n**è®¿é—®åœ°å€**: https://dev.yourdomain.com\n\n[æŸ¥çœ‹è¯¦æƒ…](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID})\"
                }
              }"
          fi
      
      - name: éƒ¨ç½²å¤±è´¥æ—¶å›æ»š
        if: failure()
        run: |
          echo "âš ï¸ éƒ¨ç½²å¤±è´¥ï¼Œå¼€å§‹å›æ»š..."
          kubectl rollout undo deployment/gva-server -n ${{ env.K8S_NAMESPACE }}
          kubectl rollout undo deployment/gva-web -n ${{ env.K8S_NAMESPACE }}
          echo "âœ… å·²å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬"



