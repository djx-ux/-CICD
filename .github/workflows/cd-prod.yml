name: CD - ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'éƒ¨ç½²ç‰ˆæœ¬ï¼ˆé•œåƒæ ‡ç­¾ï¼‰'
        required: true
        default: 'latest'

env:
  DOCKER_REGISTRY: registry.cn-hangzhou.aliyuncs.com
  IMAGE_NAME: gva
  K8S_NAMESPACE: gva-prod

jobs:
  # ============================================
  # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼ˆéœ€å®¡æ‰¹ï¼‰
  # ============================================
  deploy-production:
    name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://www.yourdomain.com
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ç”Ÿæˆéƒ¨ç½²ç‰ˆæœ¬
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.version }}"
          elif [[ ${GITHUB_REF} == refs/tags/* ]]; then
            TAG=${GITHUB_REF#refs/tags/}
          else
            COMMIT_SHA=${GITHUB_SHA::8}
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            TAG="main-${COMMIT_SHA}-${TIMESTAMP}"
          fi
          echo "TAG=${TAG}" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ éƒ¨ç½²ç‰ˆæœ¬: ${TAG}"
      
      - name: é…ç½® kubectl
        uses: azure/k8s-set-context@v4
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG_PROD }}
      
      - name: åˆ›å»ºéƒ¨ç½²å¤‡ä»½
        run: |
          # å¤‡ä»½å½“å‰éƒ¨ç½²é…ç½®
          kubectl get deployment gva-server -n ${{ env.K8S_NAMESPACE }} -o yaml > backup-server-deployment.yaml
          kubectl get deployment gva-web -n ${{ env.K8S_NAMESPACE }} -o yaml > backup-web-deployment.yaml
          
          # ä¿å­˜åˆ° artifacts
          echo "âœ… éƒ¨ç½²é…ç½®å·²å¤‡ä»½"
      
      - name: ä¸Šä¼ å¤‡ä»½é…ç½®
        uses: actions/upload-artifact@v4
        with:
          name: deployment-backup-${{ steps.version.outputs.TAG }}
          path: |
            backup-server-deployment.yaml
            backup-web-deployment.yaml
          retention-days: 30
      
      - name: é‡‘ä¸é›€å‘å¸ƒ - 10% æµé‡
        run: |
          echo "ğŸ¤ å¼€å§‹é‡‘ä¸é›€å‘å¸ƒ..."
          
          # åˆ›å»ºé‡‘ä¸é›€ç‰ˆæœ¬ï¼ˆå‰¯æœ¬æ•° = æ€»æ•°çš„ 10%ï¼‰
          kubectl patch deployment gva-server \
            -n ${{ env.K8S_NAMESPACE }} \
            -p "{\"spec\":{\"template\":{\"metadata\":{\"labels\":{\"version\":\"canary\"}}}}}"
          
          # æ›´æ–°é•œåƒ
          kubectl set image deployment/gva-server \
            gin-vue-admin-container=${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}/server:${{ steps.version.outputs.TAG }} \
            -n ${{ env.K8S_NAMESPACE }}
          
          echo "â±ï¸ ç­‰å¾…é‡‘ä¸é›€ç‰ˆæœ¬ç¨³å®š..."
          sleep 60
      
      - name: é‡‘ä¸é›€å¥åº·æ£€æŸ¥
        run: |
          # æ£€æŸ¥ Pod çŠ¶æ€
          READY_PODS=$(kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=gva-server,version=canary --field-selector=status.phase=Running -o json | jq '.items | length')
          
          if [ "$READY_PODS" -eq 0 ]; then
            echo "âŒ é‡‘ä¸é›€ç‰ˆæœ¬éƒ¨ç½²å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… é‡‘ä¸é›€ç‰ˆæœ¬è¿è¡Œæ­£å¸¸ ($READY_PODS ä¸ª Pod)"
          
          # ç›‘æ§é”™è¯¯ç‡ï¼ˆè¿™é‡Œéœ€è¦å¯¹æ¥ä½ çš„ç›‘æ§ç³»ç»Ÿï¼‰
          # ERROR_RATE=$(curl -s https://your-monitoring/api/error-rate)
          # if (( $(echo "$ERROR_RATE > 0.01" | bc -l) )); then
          #   echo "âŒ é”™è¯¯ç‡è¿‡é«˜: $ERROR_RATE"
          #   exit 1
          # fi
      
      - name: å…¨é‡å‘å¸ƒ
        run: |
          echo "ğŸš€ å¼€å§‹å…¨é‡å‘å¸ƒ..."
          
          # æ›´æ–°å‰ç«¯
          kubectl set image deployment/gva-web \
            gva-web-container=${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}/web:${{ steps.version.outputs.TAG }} \
            -n ${{ env.K8S_NAMESPACE }}
          
          # ç­‰å¾…æ‰€æœ‰æœåŠ¡å°±ç»ª
          kubectl rollout status deployment/gva-server -n ${{ env.K8S_NAMESPACE }} --timeout=10m
          kubectl rollout status deployment/gva-web -n ${{ env.K8S_NAMESPACE }} --timeout=10m
          
          echo "âœ… å…¨é‡å‘å¸ƒå®Œæˆ"
      
      - name: ç”Ÿäº§ç¯å¢ƒéªŒè¯
        run: |
          echo "ğŸ” æ‰§è¡Œç”Ÿäº§ç¯å¢ƒéªŒè¯..."
          
          # ç­‰å¾…æœåŠ¡å®Œå…¨ç¨³å®š
          sleep 60
          
          # å¥åº·æ£€æŸ¥
          # HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://www.yourdomain.com/api/health)
          # if [ "$HEALTH_STATUS" != "200" ]; then
          #   echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥: HTTP $HEALTH_STATUS"
          #   exit 1
          # fi
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=gva-server
          kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=gva-web
          
          echo "âœ… ç”Ÿäº§ç¯å¢ƒéªŒè¯é€šè¿‡"
      
      - name: æ‰“æ ‡ç­¾è®°å½•
        run: |
          # ä¸ºæˆåŠŸçš„ç”Ÿäº§éƒ¨ç½²æ‰“æ ‡ç­¾
          git tag -a "deploy-prod-${{ steps.version.outputs.TAG }}" -m "Production deployment: ${{ steps.version.outputs.TAG }}"
          # å¦‚æœéœ€è¦æ¨é€æ ‡ç­¾
          # git push origin "deploy-prod-${{ steps.version.outputs.TAG }}"
      
      - name: å‘é€æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          if [ -n "${{ secrets.DINGTALK_WEBHOOK }}" ]; then
            curl -X POST ${{ secrets.DINGTALK_WEBHOOK }} \
              -H 'Content-Type: application/json' \
              -d "{
                \"msgtype\": \"markdown\",
                \"markdown\": {
                  \"title\": \"âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸ\",
                  \"text\": \"### âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸ\n\n**ç‰ˆæœ¬**: ${{ steps.version.outputs.TAG }}\n\n**éƒ¨ç½²æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')\n\n**éƒ¨ç½²äºº**: ${GITHUB_ACTOR}\n\n**è®¿é—®åœ°å€**: https://www.yourdomain.com\n\n**æäº¤ä¿¡æ¯**: ${GITHUB_EVENT_HEAD_COMMIT_MESSAGE}\"
                }
              }"
          fi
      
      - name: éƒ¨ç½²å¤±è´¥å¤„ç†
        if: failure()
        run: |
          echo "âŒ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å¤±è´¥ï¼Œå¼€å§‹è‡ªåŠ¨å›æ»š..."
          
          # å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
          kubectl rollout undo deployment/gva-server -n ${{ env.K8S_NAMESPACE }}
          kubectl rollout undo deployment/gva-web -n ${{ env.K8S_NAMESPACE }}
          
          # ç­‰å¾…å›æ»šå®Œæˆ
          kubectl rollout status deployment/gva-server -n ${{ env.K8S_NAMESPACE }}
          kubectl rollout status deployment/gva-web -n ${{ env.K8S_NAMESPACE }}
          
          # å‘é€å¤±è´¥é€šçŸ¥
          if [ -n "${{ secrets.DINGTALK_WEBHOOK }}" ]; then
            curl -X POST ${{ secrets.DINGTALK_WEBHOOK }} \
              -H 'Content-Type: application/json' \
              -d "{
                \"msgtype\": \"text\",
                \"text\": {
                  \"content\": \"âŒ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å¤±è´¥ï¼\nç‰ˆæœ¬: ${{ steps.version.outputs.TAG }}\nå·²è‡ªåŠ¨å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬\nè¯·æ£€æŸ¥æ—¥å¿—: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}\"
                }
              }"
          fi
          
          exit 1



