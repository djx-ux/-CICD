name: CI - è…¾è®¯äº‘æŒç»­é›†æˆ

on:
  push:
    branches:
      - develop
      - main
      - 'feature/**'
      - 'release/**'
  pull_request:
    branches:
      - develop
      - main

env:
  GO_VERSION: '1.22'
  NODE_VERSION: '20'
  PNPM_VERSION: '10.18.3'

jobs:
  # ============================================
  # å‰ç«¯ä»£ç æ£€æŸ¥å’Œæµ‹è¯•
  # ============================================
  frontend-check:
    name: å‰ç«¯ä»£ç æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: è·å– pnpm store ç›®å½•
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT
      
      - name: è®¾ç½® pnpm ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: |
          cd web
          pnpm install --frozen-lockfile
      
      - name: ESLint æ£€æŸ¥
        run: |
          cd web
          pnpm lint || true
          echo "âœ… ESLint æ£€æŸ¥å®Œæˆ"
      
      - name: å‰ç«¯æ„å»ºæµ‹è¯•
        run: |
          cd web
          pnpm build
          echo "âœ… å‰ç«¯æ„å»ºæˆåŠŸ"
      
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: web/dist
          retention-days: 7

  # ============================================
  # åç«¯ä»£ç æ£€æŸ¥å’Œæµ‹è¯•
  # ============================================
  backend-check:
    name: åç«¯ä»£ç æ£€æŸ¥
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: qmPlus
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
      
      redis:
        image: redis:6.0
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: server/go.sum
      
      - name: å®‰è£… golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.61.0
      
      - name: Go Mod ä¸‹è½½
        run: |
          cd server
          go mod download
          go mod verify
      
      - name: golangci-lint æ£€æŸ¥
        run: |
          cd server
          golangci-lint run --timeout=5m || true
          echo "âœ… golangci-lint æ£€æŸ¥å®Œæˆ"
      
      - name: Go å•å…ƒæµ‹è¯•
        run: |
          cd server
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./... || true
          echo "âœ… å•å…ƒæµ‹è¯•å®Œæˆ"
      
      - name: Go æ„å»ºæµ‹è¯•
        run: |
          cd server
          go build -v -o server .
          echo "âœ… åç«¯æ„å»ºæˆåŠŸ"

  # ============================================
  # æ„å»ºå¹¶æ¨é€ Docker é•œåƒåˆ°è…¾è®¯äº‘TCR
  # ============================================
  build-and-push:
    name: æ„å»ºå¹¶æ¨é€é•œåƒåˆ°è…¾è®¯äº‘
    runs-on: ubuntu-latest
    needs: [frontend-check, backend-check]
    if: github.event_name == 'push'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ç™»å½•è…¾è®¯äº‘å®¹å™¨é•œåƒæœåŠ¡
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: ç”Ÿæˆé•œåƒæ ‡ç­¾
        id: meta
        run: |
          BRANCH=${GITHUB_REF#refs/heads/}
          COMMIT_SHA=${GITHUB_SHA::8}
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          TAG="${BRANCH}-${COMMIT_SHA}-${TIMESTAMP}"
          echo "TAG=${TAG}" >> $GITHUB_OUTPUT
          echo "BRANCH=${BRANCH}" >> $GITHUB_OUTPUT
          echo "SHORT_SHA=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ ç”Ÿæˆçš„æ ‡ç­¾: ${TAG}"
      
      - name: æ„å»ºå¹¶æ¨é€åç«¯é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./server
          file: ./server/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_REGISTRY }}/gva/server:${{ steps.meta.outputs.TAG }}
            ${{ secrets.DOCKER_REGISTRY }}/gva/server:${{ steps.meta.outputs.BRANCH }}-latest
            ${{ secrets.DOCKER_REGISTRY }}/gva/server:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            GO_PROXY=https://goproxy.cn,direct
      
      - name: æ„å»ºå¹¶æ¨é€å‰ç«¯é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./web
          file: ./web/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_REGISTRY }}/gva/web:${{ steps.meta.outputs.TAG }}
            ${{ secrets.DOCKER_REGISTRY }}/gva/web:${{ steps.meta.outputs.BRANCH }}-latest
            ${{ secrets.DOCKER_REGISTRY }}/gva/web:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: è¾“å‡ºé•œåƒä¿¡æ¯
        run: |
          echo "âœ… é•œåƒæ„å»ºå®Œæˆï¼"
          echo ""
          echo "ğŸ“¦ åç«¯é•œåƒ:"
          echo "  - ${{ secrets.DOCKER_REGISTRY }}/gva/server:${{ steps.meta.outputs.TAG }}"
          echo "  - ${{ secrets.DOCKER_REGISTRY }}/gva/server:${{ steps.meta.outputs.BRANCH }}-latest"
          echo ""
          echo "ğŸ“¦ å‰ç«¯é•œåƒ:"
          echo "  - ${{ secrets.DOCKER_REGISTRY }}/gva/web:${{ steps.meta.outputs.TAG }}"
          echo "  - ${{ secrets.DOCKER_REGISTRY }}/gva/web:${{ steps.meta.outputs.BRANCH }}-latest"
      
      - name: ä¿å­˜é•œåƒæ ‡ç­¾ä¾›åç»­Jobä½¿ç”¨
        run: |
          echo "${{ steps.meta.outputs.TAG }}" > image_tag.txt
      
      - name: ä¸Šä¼ é•œåƒæ ‡ç­¾
        uses: actions/upload-artifact@v4
        with:
          name: image-tag
          path: image_tag.txt
          retention-days: 1

  # ============================================
  # é€šçŸ¥
  # ============================================
  notify:
    name: æ„å»ºé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: always()
    
    steps:
      - name: å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥
        if: ${{ secrets.WECOM_WEBHOOK }}
        run: |
          STATUS="${{ needs.build-and-push.result }}"
          
          if [ "$STATUS" = "success" ]; then
            COLOR="info"
            STATUS_TEXT="âœ… æˆåŠŸ"
          else
            COLOR="warning"
            STATUS_TEXT="âŒ å¤±è´¥"
          fi
          
          curl -X POST ${{ secrets.WECOM_WEBHOOK }} \
            -H 'Content-Type: application/json' \
            -d "{
              \"msgtype\": \"markdown\",
              \"markdown\": {
                \"content\": \"## CI æ„å»ºé€šçŸ¥\n\n>é¡¹ç›®: **gin-vue-admin**\n>åˆ†æ”¯: **${GITHUB_REF#refs/heads/}**\n>çŠ¶æ€: <font color=\\\"${COLOR}\\\">${STATUS_TEXT}</font>\n>æäº¤è€…: **${GITHUB_ACTOR}**\n\n[æŸ¥çœ‹è¯¦æƒ…](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID})\"
              }
            }"
      
      - name: å‘é€é’‰é’‰é€šçŸ¥
        if: ${{ secrets.DINGTALK_WEBHOOK }}
        run: |
          STATUS="${{ needs.build-and-push.result }}"
          
          if [ "$STATUS" = "success" ]; then
            STATUS_TEXT="âœ… æˆåŠŸ"
          else
            STATUS_TEXT="âŒ å¤±è´¥"
          fi
          
          curl -X POST ${{ secrets.DINGTALK_WEBHOOK }} \
            -H 'Content-Type: application/json' \
            -d "{
              \"msgtype\": \"markdown\",
              \"markdown\": {
                \"title\": \"CI æ„å»ºé€šçŸ¥\",
                \"text\": \"### CI æ„å»ºé€šçŸ¥\n\n**é¡¹ç›®**: gin-vue-admin\n\n**åˆ†æ”¯**: ${GITHUB_REF#refs/heads/}\n\n**çŠ¶æ€**: ${STATUS_TEXT}\n\n**æäº¤è€…**: ${GITHUB_ACTOR}\n\n[æŸ¥çœ‹è¯¦æƒ…](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID})\"
              }
            }"

