# 🔧 紧急修复指南

## 问题诊断

### 问题1：GitHub Actions 任务被跳过 ✅

**原因**：原来的 `ci.yaml` 中的任务有条件限制
- `init` 要求 `repository_owner == 'flipped-aurora'`（你不满足）
- 其他任务依赖 `init`，所以都被跳过了

**但这不是问题！** 因为：
- `frontend` 和 `backend` 任务已经成功运行 ✅
- 其他被跳过的任务不影响你的部署

### 问题2：服务器只有 redis 容器运行 ❌

**原因**：`deploy-to-server.yml` 工作流还没有被触发过

**需要修复！**

---

## 🚀 立即修复（选择一个方法）

### 方法 1：触发自动部署（推荐）⭐

在终端运行：

```bash
# 在项目目录
cd /Users/ykmz/Desktop/哈雷彗星/gin-vue-admin

# 创建一个空提交触发部署
git commit --allow-empty -m "trigger: 触发服务器自动部署"

# 推送到 GitHub
git push origin main
```

**然后观察**：
1. 访问：https://github.com/djx-ux/-CICD/actions
2. 你会看到 **"部署到腾讯云服务器"** 工作流开始运行
3. 等待 3-5 分钟部署完成

---

### 方法 2：手动修复服务器（如果方法1失败）

#### 步骤 A：运行修复脚本

```bash
# 在项目目录
cd /Users/ykmz/Desktop/哈雷彗星/gin-vue-admin

# 运行修复脚本
./fix-server.sh
```

脚本会自动：
1. SSH 连接到服务器
2. 停止旧容器
3. 重新构建镜像
4. 启动所有服务

#### 步骤 B：手动修复（如果脚本失败）

```bash
# 1. SSH 到服务器
ssh root@119.29.95.149

# 2. 进入项目目录（需要先同步代码）
# 如果目录不存在，说明还没有自动部署过
# 那就等待方法1完成

# 如果目录存在，继续：
cd /opt/gin-vue-admin/deploy/docker-compose

# 3. 查看当前容器
docker ps -a

# 4. 停止所有容器
docker-compose down

# 5. 重新构建并启动
docker-compose build --no-cache
docker-compose up -d

# 6. 查看容器状态
docker-compose ps

# 7. 查看日志
docker-compose logs -f
```

---

## ✅ 验证修复成功

### 1. 检查 GitHub Actions

访问：https://github.com/djx-ux/-CICD/actions

应该看到：
- ✅ "部署到腾讯云服务器" 工作流成功（绿色）
- ✅ 显示 "Success"

### 2. 检查服务器容器

```bash
ssh root@119.29.95.149
docker ps
```

应该看到 4 个容器都在运行：
```
CONTAINER ID   IMAGE              STATUS          PORTS
xxxxx          gva-web            Up X minutes    0.0.0.0:8080->8080/tcp
xxxxx          gva-server         Up X minutes    0.0.0.0:8888->8888/tcp
xxxxx          gva-mysql          Up X minutes    0.0.0.0:13306->3306/tcp
xxxxx          gva-redis          Up X minutes    0.0.0.0:16379->6379/tcp
```

### 3. 访问应用

在浏览器打开：
- **前端**: http://119.29.95.149:8080
- **后端**: http://119.29.95.149:8888

应该都能正常访问！

---

## 🐛 如果还有问题

### 问题：deploy-to-server.yml 没有触发

**原因**：可能是第一次推送，GitHub 还没识别到新的工作流

**解决**：
```bash
# 再推送一次
git commit --allow-empty -m "trigger: 再次触发部署"
git push origin main
```

### 问题：服务器上没有代码

**说明**：自动部署还没有运行过

**解决**：
1. 确认 GitHub Secret `SERVER_SSH_KEY` 已配置
2. 推送代码触发部署
3. 等待 GitHub Actions 完成

### 问题：容器启动失败

**查看日志**：
```bash
ssh root@119.29.95.149
cd /opt/gin-vue-admin/deploy/docker-compose

# 查看所有容器日志
docker-compose logs

# 查看特定容器
docker-compose logs web
docker-compose logs server
docker-compose logs mysql
docker-compose logs redis
```

**常见错误**：
- MySQL 初始化失败：删除 volume 重新启动
  ```bash
  docker-compose down -v
  docker-compose up -d
  ```
- 端口被占用：检查端口
  ```bash
  netstat -tlnp | grep :8080
  netstat -tlnp | grep :8888
  ```

---

## 🎯 推荐操作流程

```bash
# 1. 触发自动部署
git commit --allow-empty -m "trigger: 部署到服务器"
git push origin main

# 2. 观察 GitHub Actions（约3-5分钟）
# 访问: https://github.com/djx-ux/-CICD/actions

# 3. 部署完成后，验证服务器
ssh root@119.29.95.149
docker ps  # 应该看到4个容器

# 4. 访问应用
# http://119.29.95.149:8080
```

---

## 📊 预期结果

### GitHub Actions

你应该看到两个工作流：

1. **CI** ✅（已完成）
   - ✅ Frontend node 18.16.0 - Success
   - ✅ Backend go (1.22) - Success
   - ⚪ init - 跳过（正常）
   - ⚪ 其他任务 - 跳过（正常）

2. **部署到腾讯云服务器** ✅（新触发）
   - ✅ 代码检查和测试
   - ✅ SSH 连接
   - ✅ 同步代码
   - ✅ 构建镜像
   - ✅ 部署容器
   - ✅ 验证部署

### 服务器状态

```bash
$ docker ps
CONTAINER ID   IMAGE          STATUS          PORTS
xxxxx          gva-web        Up 2 minutes    0.0.0.0:8080->8080/tcp
xxxxx          gva-server     Up 2 minutes    0.0.0.0:8888->8888/tcp
xxxxx          gva-mysql      Up 2 minutes    0.0.0.0:13306->3306/tcp
xxxxx          gva-redis      Up 2 minutes    0.0.0.0:16379->6379/tcp
```

---

## 🚀 现在就开始修复！

**推荐：使用方法 1（自动部署）**

```bash
cd /Users/ykmz/Desktop/哈雷彗星/gin-vue-admin
git commit --allow-empty -m "trigger: 触发服务器部署"
git push origin main
```

然后打开浏览器：
```
https://github.com/djx-ux/-CICD/actions
```

观看自动部署的魔法发生！✨

---

**修复时间**: 约 5 分钟  
**难度**: ⭐☆☆☆☆ (非常简单)

